# 进程与线程

## 进程与线程

### 进程的概念和特征

- 进程的概念
  
  - ```
    多道程序环境下，允许多程序并发执行，
    失去封闭性，并具有间断性和不可再现性。
    ```
  
  - 进程控制块PCB
    
    - 程序段
    
    - 相关数据段
    
    - PCB
    
    - ```
      创建进程实际上是创建进程实体的pcb
      进程映像是静态的，进程则是动态的
      ```

- 进程的特征
  
  - 动态性
    
    - 进程是程序的一次执行，有着创建、活动、暂停、终止等过程。
    
    - 是进程最基本的特征
  
  - 并发行
    
    - 是进程和操作系统的重要特征
  
  - 独立性
    
    - 能独立运行、独立获得资源、独立接受调度的基本单位
  
  - 异步性
    
    - 因此需要进程同步机制
  
  - ```
    进程特征不需要背诵
    ```

### 进程的状态与转换

- 运行态

- 就绪态

- 阻塞态

- 创建态

- 结束态

- 3种基本状态的转换：
  
  - 就绪态->运行态
    
    - ```
      就绪态被调度，获得处理机资源
      ```
  
  - 运行态->就绪态
    
    - ```
      处于运行态的进程在时间片用完后让出处理机
      或被更高优先级的进程抢占/剥夺
      ```
  
  - 运行态->阻塞态
    
    - ```
      请求资源
      ```
  
  - 阻塞态->就绪态
    
    - ```
      进程等待的事件到来。
      io操作结束或中断结束时，
      中断处理程序需要将相应进程的状态转为就绪态
      ```

### 进程的组织

- 进程控制块
  
  - 进程描述信息
    
    - ```进程标识符
      标志各个进程，唯一。
      ```
    
    - ```用户标识符
      进程归属的用户。用于共享和保护
      ```
  
  - 进程控制和管理信息
    
    - 进程当前状态
    
    - 进程优先级
  
  - 资源分配清单
    
    - 包括内存地址空间、虚拟地址空间，所打开列表的输入输出设备信息
  
  - 处理机相关信息
    
    - 处理器中寄存器的值

- 程序段
  
  - 能被*进程调度程序*调度到cpu执行的程序代码段

- 数据段
  
  - 进程对应的程序加工处理的原始数据/程序执行产生的中间/最终结果

### 进程控制

进程控制的程序段为**原语**

- 进程的创建
  
  - ```
    允许一个进程创建另一个进程
    前者父进程后者子进程
    子进程可以继承父进程的资源 被撤销时应当归还资源
    撤销父进程也会撤销所有子进程
    ```
  
  - 过程如下
    
    - 为新进程分配一个唯一的进程标示号，并创建空白pcb（有限）
    
    - 分配资源
    
    - 初始化pcb
    
    - 插入就绪队列（如允许）

- 进程的终止
  
  - 引起原因
    
    - 正常结束
    
    - 异常结束
      
      - 越界错误、保护错、特权指令错、io故障等
    
    - 外界干预
      
      - 操作员或操作系统干预
      
      - 父进程请求和父进程终止
  
  - 过程如下
    
    - 根据标识符检索出pcb，读出进程状态
    
    - 若处于执行状态则立刻终止
    
    - 若有子孙进程，将它们全部终止
    
    - 将所有资源归还给父进程/操作系统
    
    - 将pcb从所在队列（链表）中删除

- 进程的阻塞和唤醒
  
  - 阻塞原语block
    
    - 找到被阻塞进程的标示号对应的pcb
    
    - 若为运行态，保护现场；将其状态转为阻塞态，停止运行
    
    - 将pcb插入等待队列，将处理机资源让出
  
  - 唤醒原语wakeup
    
    - 在等待队列中找到相应进程的pcb
    
    - 将其从等待队列中移除，设为就绪态
    
    - 插入就绪队列

### 进程的通信

pv操作为低级通信方式

高级通信方法：

- 共享存储
  
  - ```
    对共享空间进行读写操作需要同步互斥工具（pv操作）
    共享存储分为两种：
        低级方式对共享基于数据结构的共享
        高级方式的共享基于存储区的共享
    ```

- 消息传递
  
  - ```
    以格式化的消息为单位
    ```
  
  - 直接通信方式
    
    - 直接把消息发给接收进程，并挂在接收进程的消息缓冲队列中
  
  - 间接通信方式
    
    - 发送进程->中间实体（一般为信箱）->接收进程

- 管道通信
  
  - 管道本质上是一种文件
  
  - 字符流的方式从发送进程送到（写）管道
  
  - 接收管道输出的接收进程从管道中接收数据
  
  - 存储空间进化为缓冲区
  
  - 半双工通信

### 线程和多线程模型

- 线程的基本概念
  
  - ```
    “轻量级进程”
    基本的cpu执行单位，程序执行流的最小单元
    是进程的一个实体，被系统独立调度和分派的基本单位
    没有自己的系统资源，同进程的多个线程可共享
    ```
  
  - 引入线程后，进程只作为除cpu外的系统资源的分配单元

- 线程与进程的比较
  
  - 调度
    
    - 同一进程的线程切换不会引起进程切换
    
    - 不同的进程的线程切换会引起
  
  - 并发性
    
    - 多进程并发、同一进程多线程并发、不同进程多线程并发
  
  - 拥有资源
    
    - 线程通过进程访问系统资源
    
    - 属于同一进程的所有线程都具有相同的地址空间
  
  - 独立性
    
    - 进程的线程对其他进程不可见
  
  - 系统开销
    
    - 撤销进程/撤销线程
  
  - 支持多处理机系统
    
    - 进程的多个线程可以分配到多个处理机上执行

- 线程的属性
  
  - 轻型实体
    
    - ```
      不拥有系统资源
      但每个线程都有唯一的标识符和线程控制块
      ```
  
  - 不同线程可执行相同的程序
  
  - 同一进程各线程共享进程的资源
  
  - 线程是独立调度单位
  
  - 线程被创建后就开始了生命周期

- 线程的状态与转换
  
  - 执行状态
  
  - 就绪状态
  
  - 阻塞状态

- 线程的组织与控制
  
  - 线程控制块TCB
    
    - 线程标识符
    
    - 一组寄存器
    
    - 线程运行状态
    
    - 优先级
    
    - 线程专有存储区
    
    - 堆栈指针
  
  - 线程的创建
    
    - 用户程序启动时通常仅有“初始化线程”在执行，用于创建新线程
  
  - 线程的终止
    
    - 完成任务或出现异常

- 线程的实现方式
