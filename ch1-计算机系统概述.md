# 计算机系统概述

## 操作系统的基本概念

### 操作系统的概念

- 操作系统
  
  ```
  控制和管理整个计算机系统的硬件与软件资源，
  合理地组织、调度计算机的工作与资源的分配，
  进而为用户和其他软件提供方便接口与环境的程序集合###操作系统的特征
  ```

### 操作系统的特征

- 并发
  
  ```
  多个事件同一时间间隔内发生
  宏观上同时执行，微观上交替执行
  并发性通过分时得以实现
  ```

- 共享
  
  - 互斥共享方式
    
    - 临界资源
  
  - 同时访问方式
    
    ```
    宏观上同时，微观上交替访问
    ```

- 虚拟
  
  ```
  把物理上的实体变为若干逻辑上的对应物
  ```
  
  - 虚拟处理器
    - 时分复用技术，多道程序设计技术
  - 虚拟存储器
    - 逻辑上扩充，空分复用技术
  - 共享设备
    - 一台物理i/o设备虚拟为多台逻辑上的设备，并允许多用户同时访问

- 异步
  
  ```
  多道程序环境允许多程序并发进行，
  但由于资源有限，进程总是走走停停且以不可预知的速度推进
  ```

并发和共享是操作系统两个**最基本**特征

两者互为存在的条件是：

- 资源共享以程序并发为条件
- 系统不能对有效进行资源共享的管理，必会影响到程序的并发执行

### 操作系统的目标和功能

应具有的功能：处理机管理、存储器管理、设备管理和文件管理

- 操作系统作为计算机系统资源的管理者
  
  - 处理机管理
  
  - 存储器管理
  
  - 文件管理
  
  - 设备管理

- 操作系统作为用户与计算机硬件系统之间的接口
  
  - 命令接口
    
    - 联机命令接口
      
      - ```强调交互性，输入一条解释一条```
        强调交互性，输入一条解释一条
        
        ```
        
        ```
  
  - 程序接口
    
    - 一组系统调用组成

- 操作系统实现了对计算机资源的扩充
  
  - 覆盖了软件的机器：扩充机器、虚拟机

## 操作系统发展历程

### 手工操作阶段

两个缺点

- 用户独占全机

- cpu等待手工操作

### 批处理阶段

- 单道批处理系统
  
  - 自动性
  
  - 顺序性
  
  - 单道性

- 多道批处理系统
  
  - 多道
  
  - 宏观上并行
  
  - 微观上串行
  
  - 优点
    
    - 计算机资源充分利用
    
    - 系统吞吐量大
  
  - 缺点
    
    - 用户响应时间长
    
    - 没有人机交互能力

### 分时操作系统

- 同时性

- 交互性

- 独立性

- 及时性

### 实时操作系统

- 硬实时系统
  
  - 某个动作必须绝对在规定时刻或时间范围发生

- 软实时系统
  
  - 能够接受偶尔违反时间规定

- 特点：及时性、可靠性

### 网络操作系统和分布式计算机系统

### 个人计算机操作系统

window、linux、macintosh

## 操作系统运行环境

### 处理器运行模式

- 特权指令

- 非特权指令

运行模式分为用户态（目态）和核心态（管态）

内核是计算机上配置的底层软件，管理着各种系统的各种资源

- 时钟管理
  
  - 通过时钟管理提供标准的系统时间
  
  - 时钟中断来实现进程的切换

- 中断机制
  
  - 提高多道程序运行环境中cpu的利用率

- 原语
  
  - 最底层最接近硬件
  
  - 原子性，不能被打断
  
  - 运行时间短，调用频繁
  
  - ```
    定义原语的直接方法是关中断，操作，开中断
    ```

- 系统控制的数据结构及处理
  
  - 进程管理
  
  - 存储器管理
  
  - 设备管理

### 中断和异常的概念

- 中断和异常的定义
  
  - 中断（外中断）
    
    - 用于信息输入输出，来自cpu执行指令外部的事件
    
    - 时钟中断表示时间片已到
  
  - 异常（内中断）
    
    - cpu执行指令内部的事件
    
    - 一旦出现就应该立刻处理

- 中断和异常的分类
  
  - 外中断
    
    - 可屏蔽中断
      
      - intr线发出的中断请求，通过改变屏蔽字可实现多重中断
    
    - 不可屏蔽中断
      
      - nmi线发出的中断请求
  
  - 异常
    
    - 故障
      
      - 由指令执行引起的执行
        
        - 非法操作码
        
        - 缺页故障
        
        - 除数为0
        
        - 运算溢出
    
    - 自陷
      
      - 事先安排的指令，用于在用户态下调用操作系统内核程序
        
        - 条件陷阱指令
    
    - 终止
      
      - cpu无法继续执行的硬件故障
        
        - 控制器出错
        
        - 存储器校验

- 中断和异常的处理

cpu执行用户程序监测到异常或中断，打断用户程序并转到相应的处理程序。若能解决问题则回到被打断的指令（或下一条）继续执行；若解决不了则直接终止用户程序。

### 系统调用

特殊的公共子程序。与资源有关的请求都通过系统调用方式向操作系统提出服务请求，并由操作系统代为完成。

- 设备管理
  
  - 设备的请求和释放，设备启动

- 文件管理
  
  - 文件的读写删除创建

- 进程控制
  
  - 进程的创建撤销阻塞唤醒

- 进程通信
  
  - 进程之间的消息传递或信号传递

- 内存管理
  
  - 内存分配、回收以及获取作业占用内存区大小及始址

执行用户程序 -> 调用系统调用 -> （内核态）执行系统调用 -> 从系统调用返回

## 操作系统结构

- 分层法
  
  - ```
    将操作系统分为若干层，层0为硬件，最高层为用户接口。
    ```
  
  - 优点
    
    - 便于系统的调试和验证
    
    - 易于扩充和维护
  
  - 问题
    
    - 合理定义各层较为困难，依赖关系固定后会不灵活
    
    - 效率差。一个功能要从上到下穿越多层，各层都有层间通信机制。

- 模块化
  
  - ```
    将操作系统按功能划分为若干具有独立性的模块。
    各模块有接口来通信，模块内也有子模块。
    模块-接口法。
    ```
  
  - 标准
    
    - 内聚性
      
      - 模块内部各部分间的联系紧密程度。内聚性越高，模块独立性越好
    
    - 耦合度
      
      - 模块间相互联系和影响的程度。耦合度越低，模块独立性越好。
  
  - 优点
    
    - 提高了操作系统设计的正确性、可理解性和可维护性。
    
    - 增强了操作系统的可适应性。
    
    - 加速了操作系统的开发过程。
  
  - 缺点
    
    - 模块间的接口规定无法满足实际需求。
    
    - 各模块设计者可能无法统一。

- 宏内核
  
  - ```
    也叫单内核、大内核。
    系统的主要功能模块都作为紧密联系的整体运行在核心态。
    windows、Android、iOS、macOS、Linux
    如今的内核一般是混合内核
    ```

- 微内核
  
  - 基本概念
    
    - 内核中最基本的功能留在内核，其余的移到用户态
    
    - 移出内核的划分为若干的服务程序，执行相互独立，交互借助微内核进行通信。
    
    - 微内核将操作系统划分为两大部分：
      
      - 微内核
        
        - 精心设计的、能实现最基本核心功能的小型内核
          
          - 与硬件处理紧密相关的部分
          
          - 比较基本的功能
          
          - 客户和服务器之间的通信
      
      - 多个服务器
  
  - 基本功能
    
    - 进程管理
    
    - 低级存储器管理
      
      - 比如实现将逻辑地址变换为物理地址的页表机制和地址变换机制
    
    - 中断和陷入处理
  
  - 微内核特点
    
    - 主要优点
      
      - 扩展性和灵活性
      
      - 可靠性和安全性
      
      - 可移植性
      
      - 分布式计算
    
    - 主要问题
      
      - 性能问题，需要频繁在核心态和用户态切换
        
        - 如果解决这个问题就是扩大微内核，但这与微内核本身相矛盾

- 外核
  
  - ```
    不同于虚拟机克隆真实机器。
    我们可以对机器进行分区，每个用户会得到整个资源的子集。
    在底层，外核exokernel会在内核态运行，
    任务是为虚拟机分配资源并检查资源的企图。
    (来保证没有机器使用他人的资源)
    ```
  
  - 优点
    
    - 减少了映射层
    
    - 将多道程序（外核内）与用户操作代码进行分离

## 操作系统引导

- 常见的操作系统引导过程
  
  - 激活cpu
    
    - cpu读取room中的boot，指令寄存器置为bios的第一条指令，开始执行bios
  
  - 硬件自检
    
    - 启动bios后，进行硬件自检
  
  - 加载带有操作系统的硬盘
    
    - bios读取boot sequence，控制权交给启动顺位第一的存储设备，cpu将该存储设备的引导扇区加载到内存中
  
  - 加载主引导记录MBR
    
    - 硬盘以特定标识符区分引导硬盘/非引导硬盘。mbr作用为告诉cpu去哪个硬盘找操作系统
  
  - 扫描硬盘分区表，并加载硬盘活动分区。
    
    - 分为活动分区/非活动分区。识别到活动分区后，加载并把控制权交给它
  
  - 加载分区引导记录PBR
    
    - 读取活动分区第一个扇区。作用是寻找并激活分区根目录下用于引导操作系统的程序
  
  - 加载启动管理器
  
  - 加载操作系统

## 虚拟机

### 虚拟机基本概念

- 第一类虚拟机管理程序
  
  - ```
    类似操作系统，唯一一个运行在最高特权级的程序。
    裸机上运行并且具备多道程序功能。
    虚拟机管理程序向上层提供若干程序，虚拟机是裸机硬件的精确复制品。
    ```
  
  - 虚拟机上的操作系统认为自己运行在内核态**虚拟内核态**
    
    - 在用户态执行特权指令会陷入虚拟机管理程序，管理程序来判断该特权指令是否需要执行（必须在支持虚拟化的cpu上才可实现）

- 第二类虚拟机管理程序
  
  - 宿主操作系统/客户操作系统

- 第一类虚拟化技术也叫裸金属架构，第二类则为寄居架构
